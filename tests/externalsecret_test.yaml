suite: external secret tests
templates:
  - templates/externalsecret.yaml
tests:
  - it: should create an ExternalSecret when enabled
    set:
      externalSecret:
        enabled: true
        secretStoreName: vault-backend
        secrets:
          - secretKey: TEST_KEY
            remoteRef:
              key: "test/path"
              property: value
    asserts:
      - isKind:
          of: ExternalSecret
      - equal:
          path: spec.secretStoreRef.name
          value: vault-backend

  - it: should not create an ExternalSecret when disabled
    set:
      externalSecret:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should resolve template variables in vault keys
    set:
      environment: staging
      imio_id: belleville
      externalSecret:
        enabled: true
        secretStoreName: vault-backend
        secrets:
          - secretKey: RELSTORAGE_DB
            remoteRef:
              key: "team/smartweb/{{ .Values.environment }}/databases/k8s/{{ .Values.imio_id }}"
              property: db_name
    asserts:
      - matchRegex:
          path: spec.data[0].remoteRef.key
          pattern: team/smartweb/staging/databases/k8s/belleville

  - it: should create multiple secret mappings
    set:
      externalSecret:
        enabled: true
        secretStoreName: vault-backend
        secrets:
          - secretKey: KEY1
            remoteRef:
              key: path1
              property: prop1
          - secretKey: KEY2
            remoteRef:
              key: path2
              property: prop2
          - secretKey: KEY3
            remoteRef:
              key: path3
              property: prop3
    asserts:
      - lengthEqual:
          path: spec.data
          count: 3
